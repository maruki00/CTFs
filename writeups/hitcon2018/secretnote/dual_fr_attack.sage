# Dual Franklin-Reiter Attack for SecretNote; written in sage
# Author: f0xtr0t
# Heap corruption (to corrupt plaintext) done by strikeskids

n = 119862919784021876896632788732171629558372753329796248983162482350943775136215497413440491349328438203285008315965797006788581255798272729713090356495902786940229344372452610435794651328026846762979934035026369509129154750405685956170565957351882235642918037290866554605828892806451168914465041465450913867263
e = 217

def enc(m):
    return pow(m, e, n)

def my_gcd(a, b):
    return a.monic() if b == 0 else my_gcd(b, a % b)

def attack(m2, m3, c1, c2, c3, c4, shifter):
    R.<X> = Zmod(n)[]

    # here X is the corruption
    f3 = (m2 + X)^217 - c3
    f4 = (m3 + X)^217 - c4

    corrupt = int(- my_gcd(f3, f4).coefficients()[0])

    # here Y is the message
    R.<Y> = Zmod(n)[]
    f1 = (Y)^217 - c1
    f2 = (Y + corrupt - shifter)^217 - c2

    m = int(- my_gcd(f1, f2).coefficients()[0])

    return m

# testing

m2 = 2 # "new" message - pt1
m3 = 3 # "new" message - pt2

c1 = 0x8dd6fb416b1e70b58144a465c535a269e1db6081ad9457cd9b782caff954685149c773f94d0b242fdd4dbe918d4872be421cc0b86dbd92745c8c2088ddf002d975331a74cdcb50e9c15d9ed24b0d53a3a1f7c9dd4ce6343e7f1d5646e8addea3e4d24176da52abcaab426737bbd503140487fd4f34c2b7cb7e41a0c06a316a21
c2 = 0x82695e4155fde9622e3f1bdd72b0672b75085e24aba04ec2f4fd87d8bd155d538b580ab37f357b10e8f7b0882d05c9636312d8ca641c7937d78435a57cb4760ffd7e3a6e4a7ca414658d5c4d20b70853958a9daec10154abe5117b05b3941852515901a6b5be0a60386ce445f076e158da670415363b5b4b3c80ab7d1bb85ece
c3 = 0x347bbf9e29b73b388cc092a0ec472fee091640ef90b3d0a296effda8a0b839e49b0778bfa3a1db98c1e2a5bdef75b90d0b2b20ba4299ecce76549584340b647acd45b5028ffe2a39fecc9053be443d7a54054d82f74e115838e9c4b11ca2b20327262841674313d9498d421b69b50ae4aae8f6d5f941adc1ce4df0c32d3b7048
c4 = 0x9cc28a84c7a0b49575a068ac468ea369b3c009bc5ec058cc89982d50dbce153db4a1c645cb0db3f6a55febf494d793a71016ba3e3778e5396c788d4de73b0acb47b90004b01924e79a673cf9ad18d5207777f2285debf9477861fdcc1b81f964547eceb8c4d9f14d4019c3716e0ac05a8702a201753d2e97736893757a6e4b48

shifter = 0x6b65793a00000000000000000000000000000000

print hex(attack(m2, m3, c1, c2, c3, c4, shifter)).replace('0x','').replace('L','').decode('hex')
